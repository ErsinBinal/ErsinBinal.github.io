<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BLOCKY RIVER: CRAFT EDITION</title>
    <style>
        body { margin: 0; padding: 0; background: #1a1a1a; overflow: hidden; touch-action: none; }
        #game-container { width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; background: #000; }
        canvas { 
            box-shadow: 0 0 0 4px #333, 0 0 20px rgba(0,0,0,0.5); 
            image-rendering: pixelated; /* Pikseller keskin görünsün */
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>
<body>

<div id="game-container"></div>

<script>
const CONFIG = {
    type: Phaser.AUTO,
    width: window.innerWidth > 600 ? 600 : window.innerWidth,
    height: window.innerHeight,
    parent: 'game-container',
    pixelArt: true, // Phaser'a piksel sanatı olduğunu söylüyoruz
    physics: {
        default: 'arcade',
        arcade: { gravity: { y: 0 }, debug: false }
    },
    scene: { preload: preload, create: create, update: update }
};

let game = new Phaser.Game(CONFIG);
let player, cursors, bullets, enemies, fuels, terrainLeft, terrainRight, riverWater;
let score = 0, scoreText, fuel = 100, fuelBar, fuelBarBg, gameSpeed = 2;
let isGameOver = false, lastFired = 0;

function preload() {
    let g = this.make.graphics({x: 0, y: 0, add: false});

    // --- YARDIMCI FONKSİYON: PİKSEL ÇİZİCİ ---
    // Verilen matrise göre blok blok çizer
    const drawBlockySprite = (key, width, height, pixelSize, matrix, palette) => {
        g.clear();
        for (let y = 0; y < matrix.length; y++) {
            for (let x = 0; x < matrix[y].length; x++) {
                let colorCode = matrix[y][x];
                if (colorCode !== 0 && palette[colorCode]) {
                    g.fillStyle(palette[colorCode], 1);
                    // Hafif gölge efekti (Bevel)
                    g.fillRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize);
                    
                    // İç gölge (Daha bloklu hissetmesi için)
                    g.fillStyle(0x000000, 0.1);
                    g.fillRect(x * pixelSize + pixelSize - 2, y * pixelSize, 2, pixelSize);
                    g.fillRect(x * pixelSize, y * pixelSize + pixelSize - 2, pixelSize, 2);
                }
            }
        }
        g.generateTexture(key, width * pixelSize, height * pixelSize);
    };

    // 1. OYUNCU: BLUE STARFIGHTER (Minecraft Elytra tarzı)
    // 1: Koyu Mavi, 2: Açık Mavi (Cam), 3: Gri (Motor), 4: Turuncu (Alev)
    const playerPalette = { 1: 0x0055aa, 2: 0x44ccff, 3: 0x555555, 4: 0xffaa00 };
    const playerMatrix = [
        [0,0,0,1,1,0,0,0],
        [0,0,1,1,1,1,0,0],
        [0,0,1,2,2,1,0,0], // Kokpit
        [0,1,1,1,1,1,1,0],
        [1,1,1,3,3,1,1,1],
        [1,0,1,3,3,1,0,1],
        [1,0,0,4,4,0,0,1], // Alevler
        [0,0,0,4,4,0,0,0]
    ];
    drawBlockySprite('playerShip', 8, 8, 6, playerMatrix, playerPalette); // 6x scale

    // 2. DÜŞMAN: CREEPER HELICOPTER
    // 1: Yeşil (Creeper), 2: Siyah, 3: Gri (Pervane)
    const heliPalette = { 1: 0x00aa00, 2: 0x000000, 3: 0xcccccc };
    const heliMatrix = [
        [0,3,0,3,0,3,0], // Pervane
        [0,0,3,3,3,0,0],
        [0,0,1,1,1,0,0],
        [0,1,1,1,1,1,0],
        [1,1,2,1,2,1,1], // Gözler
        [1,1,1,2,1,1,1], // Ağız
        [0,0,1,2,1,0,2], // Kuyruk
    ];
    drawBlockySprite('enemyHeli', 7, 7, 6, heliMatrix, heliPalette);

    // 3. DÜŞMAN: IRON GOLEM JET
    // 1: Beyaz/Demir, 2: Kırmızı (Göz), 3: Koyu Gri
    const jetPalette = { 1: 0xeeeeee, 2: 0xff0000, 3: 0x444444 };
    const jetMatrix = [
        [0,0,0,1,0,0,0],
        [0,0,1,1,1,0,0],
        [0,1,1,2,1,1,0],
        [1,1,1,1,1,1,1],
        [1,0,3,1,3,0,1],
        [0,0,3,0,3,0,0]
    ];
    drawBlockySprite('enemyJet', 7, 6, 6, jetMatrix, jetPalette);

    // 4. DÜŞMAN: OBSIDIAN SHIP
    // 1: Mor/Siyah (Obsidyen), 2: Mor (Parlak)
    const shipPalette = { 1: 0x220033, 2: 0x6600aa };
    const shipMatrix = [
        [0,0,1,1,0,0],
        [0,0,1,2,0,0], // Kule
        [1,1,1,1,1,1],
        [1,2,1,1,2,1],
        [0,1,1,1,1,0]
    ];
    drawBlockySprite('enemyShip', 6, 5, 8, shipMatrix, shipPalette);

    // 5. YAKIT: TNT BLOCK / REDSTONE
    // 1: Kırmızı, 2: Beyaz, 3: Siyah
    const fuelPalette = { 1: 0xff0000, 2: 0xffffff, 3: 0x000000 };
    const fuelMatrix = [
        [1,1,1,1,1],
        [1,2,2,2,1],
        [1,2,3,2,1], // T N T yazısı gibi
        [1,2,2,2,1],
        [1,1,1,1,1]
    ];
    drawBlockySprite('fuelTank', 5, 5, 8, fuelMatrix, fuelPalette);

    // 6. SU DOKUSU (Minecraft Water)
    g.clear();
    g.fillStyle(0x0000aa, 1); // Ana Su Rengi
    g.fillRect(0,0,64,64);
    g.fillStyle(0x0000ff, 1); // Açık Mavi Noktalar
    for(let i=0; i<20; i++) g.fillRect(Phaser.Math.Between(0,60), Phaser.Math.Between(0,60), 4, 4);
    g.generateTexture('waterTile', 64, 64);

    // 7. ÇİMENLİ DUVAR (Grass Block)
    g.clear();
    g.fillStyle(0x795548, 1); // Toprak (Kahverengi)
    g.fillRect(0,0,64,64);
    g.fillStyle(0x4caf50, 1); // Çimen (Yeşil - Üst Kısım)
    g.fillRect(0,0,64,16); 
    // Çimen sarkması
    g.fillRect(4,16,4,4); g.fillRect(12,16,4,8); g.fillRect(24,16,4,4); g.fillRect(40,16,4,6);
    // Toprak detayları
    g.fillStyle(0x5d4037, 1);
    g.fillRect(10,30,4,4); g.fillRect(50,50,4,4);
    g.generateTexture('wallBlock', 64, 64);

    // 8. MERMİ (Sarı Kare)
    g.clear(); g.fillStyle(0xffff00, 1); g.fillRect(0,0,8,8); g.generateTexture('bullet', 8, 8);

    // 9. PARTİKÜL (Blok parçası)
    g.clear(); g.fillStyle(0xffffff, 1); g.fillRect(0,0,6,6); g.generateTexture('particle', 6, 6);
}

function create() {
    // 1. NEHİR SUYU (Hareketli Zemin)
    riverWater = this.add.tileSprite(CONFIG.width/2, CONFIG.height/2, CONFIG.width, CONFIG.height, 'waterTile');
    riverWater.setScale(2); // Bloklar büyük görünsün

    // 2. KANYON DUVARLARI
    // Sol ve Sağ duvarları blok blok döşemek yerine tileSprite ile yapıyoruz ama "bloklu" texture kullanıyoruz.
    let wallWidth = 64;
    terrainLeft = this.add.tileSprite(wallWidth/2, CONFIG.height/2, wallWidth, CONFIG.height, 'wallBlock');
    this.physics.add.existing(terrainLeft, true);
    
    terrainRight = this.add.tileSprite(CONFIG.width - wallWidth/2, CONFIG.height/2, wallWidth, CONFIG.height, 'wallBlock');
    this.physics.add.existing(terrainRight, true);

    // 3. OYUNCU
    player = this.physics.add.sprite(CONFIG.width/2, CONFIG.height - 100, 'playerShip');
    player.setCollideWorldBounds(true);
    player.setDrag(800); 
    player.setDepth(10);
    player.body.setSize(30, 30); // Hitbox

    // 4. GRUPLAR
    bullets = this.physics.add.group();
    enemies = this.physics.add.group();
    fuels = this.physics.add.group();

    // 5. ARAYÜZ (Minecraft Fontuna Benzer)
    const fontStyle = { fontSize: '20px', fill: '#fff', stroke: '#000', strokeThickness: 4, fontFamily: 'Courier New' };
    scoreText = this.add.text(80, 20, 'SCORE: 0', fontStyle).setDepth(20);
    
    // XP Barı gibi Yakıt Barı
    this.add.text(80, 52, 'FUEL', { fontSize:'14px', fill:'#fff' }).setDepth(20);
    fuelBarBg = this.add.rectangle(180, 60, 204, 14, 0x333333).setStrokeStyle(2, 0xffffff).setDepth(20);
    fuelBar = this.add.rectangle(180, 60, 200, 10, 0x00ff00).setDepth(20);

    // 6. KONTROLLER
    cursors = this.input.keyboard.createCursorKeys();
    this.input.on('pointermove', (pointer) => {
        if (!isGameOver && pointer.isDown) {
            let targetX = Phaser.Math.Clamp(pointer.x, 80, CONFIG.width - 80);
            this.physics.moveTo(player, targetX, pointer.y - 50, 400);
            fireWeapon.call(this);
        }
    });

    // 7. ÇARPIŞMALAR
    this.physics.add.overlap(bullets, enemies, hitEnemy, null, this);
    this.physics.add.overlap(bullets, fuels, hitFuelTank, null, this);
    this.physics.add.overlap(player, enemies, crashPlayer, null, this);
    this.physics.add.overlap(player, fuels, collectFuel, null, this);

    // 8. SPAWNERS
    this.time.addEvent({ delay: 1500, callback: spawnEnemy, callbackScope: this, loop: true });
    this.time.addEvent({ delay: 500, callback: decreaseFuel, callbackScope: this, loop: true });
}

function update() {
    if (isGameOver) return;

    // Bloklu kaydırma efekti (Piksel piksel kaysın diye Math.floor kullanılabilir ama akıcılık için düz bırakıyoruz)
    riverWater.tilePositionY -= gameSpeed;
    terrainLeft.tilePositionY -= gameSpeed;
    terrainRight.tilePositionY -= gameSpeed;

    player.setVelocityX(0);
    player.setVelocityY(0);
    
    let speed = 350;
    if (cursors.left.isDown) player.setVelocityX(-speed);
    else if (cursors.right.isDown) player.setVelocityX(speed);
    if (cursors.up.isDown) player.setVelocityY(-speed);
    else if (cursors.down.isDown) player.setVelocityY(speed);
    
    if (player.x < 80) player.x = 80;
    if (player.x > CONFIG.width - 80) player.x = CONFIG.width - 80;

    if (cursors.space.isDown) fireWeapon.call(this);

    bullets.children.each(b => { if (b.y < -50) b.destroy(); });
    enemies.children.each(e => { if (e.y > CONFIG.height + 50) e.destroy(); });
    fuels.children.each(f => { if (f.y > CONFIG.height + 50) f.destroy(); });

    // Yakıt Barı Renkleri (Yeşil -> Sarı -> Kırmızı)
    fuelBar.width = Math.max(0, (fuel / 100) * 200);
    if (fuel > 50) fuelBar.fillColor = 0x00ff00;
    else if (fuel > 20) fuelBar.fillColor = 0xffff00;
    else fuelBar.fillColor = 0xff0000;
}

function spawnEnemy() {
    if (isGameOver) return;
    let x = Phaser.Math.Between(90, CONFIG.width - 90);
    let chance = Phaser.Math.Between(0, 100);

    if (chance < 20) {
        let f = fuels.create(x, -50, 'fuelTank');
        f.setVelocityY(gameSpeed * 60);
    } else {
        let type = 'enemyHeli';
        let speed = 80;
        if (chance > 50 && chance < 80) { type = 'enemyJet'; speed = 180; }
        else if (chance >= 80) { type = 'enemyShip'; speed = 40; }

        let e = enemies.create(x, -50, type);
        e.setVelocityY(speed + (gameSpeed * 20));
        
        // Helikopter: Creeper gibi sinsi hareket
        if (type === 'enemyHeli') {
            this.tweens.add({
                targets: e, x: e.x + 40, duration: 1500, yoyo: true, repeat: -1, ease: 'Stepped' // Bloklu hareket
            });
        }
    }
}

function fireWeapon() {
    let now = this.time.now;
    if (now - lastFired < 200) return;
    let b = bullets.create(player.x, player.y - 30, 'bullet');
    b.setVelocityY(-700);
    lastFired = now;
}

function hitEnemy(bullet, enemy) {
    bullet.destroy();
    createExplosion(this, enemy.x, enemy.y, 0xffffff, 15); // Beyaz duman (Minecraft ölüm efekti gibi)
    enemy.destroy();
    score += 100;
    scoreText.setText('SCORE: ' + score);
    if (score % 2000 === 0) gameSpeed += 0.5;
}

function hitFuelTank(bullet, tank) {
    bullet.destroy();
    tank.destroy();
    createExplosion(this, tank.x, tank.y, 0xff0000, 30); // TNT patlaması
    score -= 200;
    scoreText.setText('SCORE: ' + score);
}

function collectFuel(player, tank) {
    tank.destroy();
    fuel = Math.min(100, fuel + 40);
    score += 50;
    scoreText.setText('SCORE: ' + score);
    // XP Sesi efekti yazısı
    let xpText = this.add.text(player.x, player.y-40, '+XP', {fontSize:'16px', fill:'#0f0'});
    this.tweens.add({targets:xpText, y:player.y-80, alpha:0, duration:800});
}

function crashPlayer(player, enemy) {
    createExplosion(this, player.x, player.y, 0x00aaff, 30);
    createExplosion(this, enemy.x, enemy.y, 0xff0000, 20);
    player.setVisible(false);
    gameOver.call(this, "WASTED!");
}

function decreaseFuel() {
    if (isGameOver) return;
    fuel -= 1.0;
    if (fuel <= 0) gameOver.call(this, "OUT OF FUEL");
}

function createExplosion(scene, x, y, color, count) {
    // Kare parçacıklar
    let particles = scene.add.particles(0, 0, 'particle', {
        x: x, y: y,
        speed: { min: 50, max: 200 },
        angle: { min: 0, max: 360 },
        scale: { start: 2, end: 0 }, // Büyük bloklar küçülür
        rotate: { min: 0, max: 90 }, // Dönerek dağılır
        tint: color,
        lifespan: 600,
        quantity: count
    });
    scene.time.delayedCall(600, () => particles.destroy());
}

function gameOver(reason) {
    isGameOver = true;
    this.physics.pause();
    
    // Minecraft menüsü tarzı
    let bg = this.add.rectangle(CONFIG.width/2, CONFIG.height/2, 400, 250, 0x333333).setStrokeStyle(4, 0xffffff);
    
    this.add.text(CONFIG.width/2, CONFIG.height/2 - 50, reason, { fontSize: '32px', fill: '#ff5555', fontFamily: 'Courier New', fontWeight:'bold' }).setOrigin(0.5);
    this.add.text(CONFIG.width/2, CONFIG.height/2, 'SCORE: ' + score, { fontSize: '28px', fill: '#ffffff', fontFamily: 'Courier New' }).setOrigin(0.5);
    
    let btn = this.add.text(CONFIG.width/2, CONFIG.height/2 + 70, '[ RESPAWN ]', { 
        fontSize: '24px', fill: '#55ff55', backgroundColor:'#000', padding:10, fontFamily: 'Courier New' 
    }).setOrigin(0.5).setInteractive();
    
    btn.on('pointerdown', () => location.reload());
}
</script>
</body>
</html>
