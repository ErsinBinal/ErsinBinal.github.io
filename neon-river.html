<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON RIVER: ULTIMATE</title>
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; touch-action: none; }
        #game-container { width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        canvas { box-shadow: 0 0 50px rgba(0,255,0,0.2); border: 2px solid #0f0; }
        /* CRT Scanline Efekti */
        body::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>
<body>

<div id="game-container"></div>

<script>
// --- OYUN AYARLARI ---
const CONFIG = {
    type: Phaser.AUTO,
    width: window.innerWidth > 800 ? 600 : window.innerWidth, // Mobilde tam ekran, PC'de dikey arcade formatı
    height: window.innerHeight,
    parent: 'game-container',
    physics: {
        default: 'arcade',
        arcade: { gravity: { y: 0 }, debug: false }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

let game = new Phaser.Game(CONFIG);

// --- DEĞİŞKENLER ---
let player;
let cursors;
let bullets;
let enemyBullets;
let enemies;
let powerups;
let sidekicks; // Yardımcı drone grubu
let bgCity; // Arka plan
let score = 0;
let scoreText;
let level = 1;
let levelText;
let fuel = 100;
let fuelBar;
let isGameOver = false;
let bossActive = false;
let boss; // Boss objesi

// Silah Sistemi
const WEAPONS = {
    SINGLE: 0,
    SPREAD: 1, // Yayılan
    LASER: 2, // Lazer
    ROCKET: 3, // Roket
    HOMING: 4, // Takip Eden
    WAVE: 5 // Ses Dalgası
};
let currentWeapon = WEAPONS.SINGLE;
let lastFired = 0;

// --- PRELOAD (Varlık Yükleme / Oluşturma) ---
function preload() {
    // Harici resim kullanmıyoruz, dokuları kodla çiziyoruz (Texture Generation)
    // Bu sayede "resim yok" hatası almazsın ve Cyberpunk estetiği korunur.
    
    // 1. Oyuncu Uçağı (Jet Görünümü)
    const graphics = this.make.graphics({x: 0, y: 0, add: false});
    graphics.lineStyle(2, 0x00ffff);
    graphics.fillStyle(0x002222, 1);
    graphics.beginPath();
    graphics.moveTo(0, -20); // Burun
    graphics.lineTo(15, 10); // Sağ Kanat ucu
    graphics.lineTo(5, 10);  // Gövde yanı
    graphics.lineTo(8, 20);  // Sağ kuyruk
    graphics.lineTo(-8, 20); // Sol kuyruk
    graphics.lineTo(-5, 10); // Gövde yanı
    graphics.lineTo(-15, 10);// Sol kanat ucu
    graphics.closePath();
    graphics.fillPath();
    graphics.strokePath();
    graphics.generateTexture('playerShip', 40, 45);

    // 2. Düşmanlar (3 Tip)
    // Tip 1: Standart Avcı
    graphics.clear();
    graphics.lineStyle(2, 0xff0000);
    graphics.beginPath();
    graphics.moveTo(0, 15); graphics.lineTo(15, -15); graphics.lineTo(-15, -15); graphics.closePath();
    graphics.strokePath();
    graphics.generateTexture('enemy1', 32, 32);

    // Tip 2: Bombardıman (Yuvarlak)
    graphics.clear();
    graphics.lineStyle(2, 0xffaa00);
    graphics.strokeCircle(16, 16, 14);
    graphics.generateTexture('enemy2', 32, 32);

    // Tip 3: Hızlı Kesici (Ok)
    graphics.clear();
    graphics.lineStyle(2, 0xff00ff);
    graphics.beginPath();
    graphics.moveTo(0, 20); graphics.lineTo(10, -20); graphics.lineTo(-10, -20); graphics.closePath();
    graphics.strokePath();
    graphics.generateTexture('enemy3', 24, 40);

    // 3. Boss (Büyük Ana Gemi)
    graphics.clear();
    graphics.lineStyle(4, 0xff0000);
    graphics.fillStyle(0x330000);
    graphics.beginPath();
    graphics.moveTo(0, 60); graphics.lineTo(50, -40); graphics.lineTo(20, -60); graphics.lineTo(-20, -60); graphics.lineTo(-50, -40); graphics.closePath();
    graphics.fillPath();
    graphics.strokePath();
    graphics.generateTexture('boss', 120, 140);

    // 4. Mermiler ve Poweruplar
    graphics.clear(); graphics.fillStyle(0xffff00); graphics.fillCircle(4,4,4); graphics.generateTexture('bullet', 8, 8);
    graphics.clear(); graphics.fillStyle(0x00ff00); graphics.fillRect(0,0,8,20); graphics.generateTexture('laser', 8, 20);
    graphics.clear(); graphics.fillStyle(0xffaa00); graphics.fillTriangle(0,0, 8,8, 0,16); graphics.generateTexture('rocket', 10, 20);
    graphics.clear(); graphics.lineStyle(2, 0x00ff00); graphics.strokeRect(0,0,20,20); graphics.generateTexture('fuelBox', 20, 20);
    graphics.clear(); graphics.lineStyle(2, 0x00ffff); graphics.strokeCircle(10,10,10); graphics.generateTexture('weaponBox', 20, 20);
    
    // 5. Sidekick (Yardımcı Drone)
    graphics.clear(); graphics.lineStyle(2, 0x00ff00); graphics.strokeCircle(8,8,6); graphics.generateTexture('sidekick', 16, 16);

    // 6. Arka Plan (Şehir/Metro Izgarası)
    graphics.clear();
    graphics.lineStyle(1, 0x004400, 0.3); // Çok silik yeşil çizgiler
    // Izgara çizimi
    for(let i=0; i<400; i+=40) { graphics.moveTo(i, 0); graphics.lineTo(i, 400); }
    for(let i=0; i<400; i+=40) { graphics.moveTo(0, i); graphics.lineTo(400, i); }
    // Rastgele binalar (bloklar)
    graphics.fillStyle(0x001100, 0.5);
    for(let i=0; i<10; i++) {
        graphics.fillRect(Phaser.Math.Between(0,350), Phaser.Math.Between(0,350), Phaser.Math.Between(20,60), Phaser.Math.Between(20,60));
    }
    graphics.strokePath();
    graphics.fillPath();
    graphics.generateTexture('bgCity', 400, 400);
}

// --- CREATE (Başlangıç Kurulumu) ---
function create() {
    // Arka Plan (TileSprite ile kayan zemin)
    bgCity = this.add.tileSprite(CONFIG.width/2, CONFIG.height/2, CONFIG.width, CONFIG.height, 'bgCity');
    
    // Gruplar
    bullets = this.physics.add.group();
    enemyBullets = this.physics.add.group();
    enemies = this.physics.add.group();
    powerups = this.physics.add.group();
    sidekicks = this.physics.add.group(); // Sidekick grubu

    // Oyuncu
    player = this.physics.add.sprite(CONFIG.width / 2, CONFIG.height - 100, 'playerShip');
    player.setCollideWorldBounds(true);
    player.setDrag(200); // Sürtünme
    player.setImmovable(true);

    // UI
    scoreText = this.add.text(10, 10, 'SKOR: 0', { fontSize: '20px', fill: '#0f0', fontFamily: 'Courier' });
    levelText = this.add.text(10, 35, 'LEVEL: 1', { fontSize: '20px', fill: '#0ff', fontFamily: 'Courier' });
    
    // Yakıt Barı
    this.add.text(CONFIG.width - 110, 10, 'YAKIT', { fontSize: '14px', fill: '#0f0', fontFamily: 'Courier' });
    let fuelContainer = this.add.rectangle(CONFIG.width - 60, 25, 100, 15, 0x000000).setStrokeStyle(2, 0x00ff00);
    fuelBar = this.add.rectangle(CONFIG.width - 108, 25, 96, 11, 0x00ff00).setOrigin(0, 0.5);

    // Kontroller
    cursors = this.input.keyboard.createCursorKeys();
    this.input.keyboard.on('keydown-SPACE', fireWeapon, this);

    // Mobil Kontrol (Sürükle ve Ateş Et)
    this.input.on('pointermove', function (pointer) {
        if(pointer.isDown && !isGameOver) {
            this.physics.moveTo(player, pointer.x, pointer.y - 50, 400); // Parmağın biraz üzerine git
            fireWeapon.call(this); // Otomatik ateş
        } else {
            player.setVelocity(0);
        }
    }, this);

    // Çarpışmalar
    this.physics.add.overlap(bullets, enemies, hitEnemy, null, this);
    this.physics.add.overlap(player, enemies, playerHit, null, this);
    this.physics.add.overlap(player, powerups, collectPowerup, null, this);
    this.physics.add.overlap(player, enemyBullets, playerHit, null, this);
    this.physics.add.overlap(bullets, boss, hitBoss, null, this); // Mermi -> Boss

    // Zamanlayıcılar
    this.time.addEvent({ delay: 1000, callback: consumeFuel, callbackScope: this, loop: true });
    this.time.addEvent({ delay: 1500, callback: spawnEnemy, callbackScope: this, loop: true });
    
    // Boss Başlatıcı (Örnek: 30 saniye sonra level sonu)
    this.time.addEvent({ delay: 30000, callback: startBossFight, callbackScope: this });
}

// --- UPDATE (Oyun Döngüsü) ---
function update() {
    if (isGameOver) return;

    // Arka Plan Kaydırma (Uçuş hissi)
    bgCity.tilePositionY -= 2; // Metro akışı

    // Oyuncu Hareketi (Klavye)
    player.setVelocity(0);
    if (cursors.left.isDown) player.setVelocityX(-300);
    else if (cursors.right.isDown) player.setVelocityX(300);
    
    if (cursors.up.isDown) player.setVelocityY(-300);
    else if (cursors.down.isDown) player.setVelocityY(300);

    // Otomatik Sidekick Ateşi
    sidekicks.children.iterate(function (drone) {
        if (drone) {
            // Drone oyuncuyu takip etsin
            // Basit bir yay hareketi veya direkt takip
            drone.y -= 0; // Sabit kalsın
            if(Phaser.Math.Between(0, 50) > 48) {
                let b = bullets.create(drone.x, drone.y, 'bullet');
                b.setVelocityY(-400);
            }
        }
    });

    // Roket Takibi (Homing Missile)
    if (currentWeapon === WEAPONS.HOMING) {
        bullets.children.iterate(function (bullet) {
            if (bullet && bullet.getData('type') === 'homing') {
                let target = enemies.getFirstAlive();
                if(bossActive && boss && boss.active) target = boss;
                
                if (target) {
                    this.physics.moveToObject(bullet, target, 400);
                }
            }
        }, this);
    }
    
    // Temizlik
    bullets.children.each(b => { if(b.y < -50) b.destroy(); });
    enemies.children.each(e => { 
        if(e.y > CONFIG.height + 50) e.destroy(); 
        // Düşman ateşi (rastgele)
        if(e.active && Phaser.Math.Between(0, 500) > 495) {
            let eb = enemyBullets.create(e.x, e.y, 'bullet');
            eb.setTint(0xff0000);
            eb.setVelocityY(300);
        }
    });

    // Boss Hareketi (Basit yapay zeka)
    if (bossActive && boss && boss.active) {
        if (boss.x < 50) boss.setVelocityX(150);
        else if (boss.x > CONFIG.width - 50) boss.setVelocityX(-150);
        
        // Boss Ateşi
        if (Phaser.Math.Between(0, 100) > 95) {
            // Saçılan ateş
            for(let i=-2; i<=2; i++) {
                let eb = enemyBullets.create(boss.x, boss.y+40, 'bullet');
                eb.setTint(0xff00ff);
                eb.setVelocity(i*50, 300);
            }
        }
    }
}

// --- FONKSİYONLAR ---

function fireWeapon() {
    if (isGameOver) return;
    let time = this.time.now;
    if (time < lastFired) return;

    let fireRate = 300; // Varsayılan hız

    switch (currentWeapon) {
        case WEAPONS.SINGLE:
            let b1 = bullets.create(player.x, player.y - 20, 'bullet');
            b1.setVelocityY(-500);
            break;

        case WEAPONS.SPREAD: // Yayılan
            for(let i=-2; i<=2; i++) {
                let b = bullets.create(player.x, player.y - 20, 'bullet');
                b.setVelocity(i * 50, -500);
            }
            fireRate = 400;
            break;

        case WEAPONS.LASER: // Hızlı düz
            let l = bullets.create(player.x, player.y - 30, 'laser');
            l.setVelocityY(-800);
            fireRate = 150;
            break;
            
        case WEAPONS.ROCKET: // Güçlü ama yavaş
            let r = bullets.create(player.x, player.y - 20, 'rocket');
            r.setVelocityY(-300);
            r.setScale(1.5);
            r.setData('damage', 5); // Roket çok vurur
            fireRate = 600;
            break;

        case WEAPONS.HOMING: // Takip eden
            let h = bullets.create(player.x, player.y - 20, 'rocket');
            h.setTint(0x00ff00);
            h.setVelocityY(-300);
            h.setData('type', 'homing');
            fireRate = 500;
            break;
            
        case WEAPONS.WAVE: // Ses Dalgası (Geniş hitbox)
            let w = bullets.create(player.x, player.y - 20, 'bullet'); // Geçici görsel
            w.setScale(5, 1); // Yatayda geniş
            w.setVelocityY(-400);
            w.setTint(0x0000ff);
            fireRate = 600;
            break;
    }
    
    // Sidekickler de ateş etsin (Update döngüsünde hallediliyor)
    lastFired = time + fireRate;
}

function spawnEnemy() {
    if(bossActive) return; // Boss varken normal düşman gelmesin

    let x = Phaser.Math.Between(30, CONFIG.width - 30);
    let type = Phaser.Math.Between(1, 3);
    let key = 'enemy' + type;
    
    let enemy = enemies.create(x, -50, key);
    enemy.setVelocityY(Phaser.Math.Between(100, 250));
    
    // Yakıt tankı şansı
    if(Phaser.Math.Between(0, 100) > 90) {
        let f = powerups.create(Phaser.Math.Between(30, CONFIG.width-30), -50, 'fuelBox');
        f.setVelocityY(100);
        f.setData('type', 'fuel');
    }
    
    // Silah kutusu şansı
    if(Phaser.Math.Between(0, 100) > 95) {
        let w = powerups.create(Phaser.Math.Between(30, CONFIG.width-30), -50, 'weaponBox');
        w.setVelocityY(150);
        w.setData('type', 'weapon');
    }
}

function startBossFight() {
    bossActive = true;
    levelText.setText('BOSS FIGHT!');
    levelText.setColor('#ff0000');
    
    boss = this.physics.add.sprite(CONFIG.width/2, -100, 'boss');
    boss.setHealth = 50 + (level * 20); // Level arttıkça can artar
    boss.hp = boss.setHealth;
    boss.setVelocityY(50);
    
    // Sahneye giriş
    this.tweens.add({
        targets: boss,
        y: 100,
        duration: 2000,
        onComplete: function() {
            boss.setVelocityX(150);
            boss.setVelocityY(0);
        }
    });
}

function hitEnemy(bullet, enemy) {
    bullet.destroy();
    
    // Roket ise alan hasarı veya tek vuruş
    let dmg = bullet.getData('damage') || 1;
    
    // Düşman yok etme
    createExplosion(this, enemy.x, enemy.y);
    enemy.destroy();
    score += 10;
    scoreText.setText('SKOR: ' + score);
}

function hitBoss(bullet, bossSprite) {
    bullet.destroy();
    let dmg = bullet.getData('damage') || 1;
    bossSprite.hp -= dmg;
    
    // Boss yanıp sönsün
    bossSprite.setTint(0xff0000);
    this.time.delayedCall(100, () => bossSprite.clearTint());

    if (bossSprite.hp <= 0) {
        createExplosion(this, bossSprite.x, bossSprite.y, 2);
        bossSprite.destroy();
        bossActive = false;
        levelUp.call(this);
    }
}

function playerHit(player, threat) {
    threat.destroy();
    createExplosion(this, player.x, player.y);
    gameOver.call(this);
}

function collectPowerup(player, box) {
    let type = box.getData('type');
    box.destroy();
    
    if (type === 'fuel') {
        fuel = Math.min(100, fuel + 30);
        updateFuelBar();
        // Puan sesi (Phaser ile ses eklenebilir ama şimdilik görsel)
    } else if (type === 'weapon') {
        // Rastgele silah veya Sidekick
        let rand = Phaser.Math.Between(1, 6);
        if (rand === 6) {
            addSidekick.call(this);
        } else {
            currentWeapon = rand; // Enum değerleri 1-5 arası silahlar
        }
        
        let wName = ['SINGLE', 'SPREAD', 'LASER', 'ROCKET', 'HOMING', 'WAVE'][currentWeapon];
        let txt = this.add.text(player.x, player.y - 50, wName, { fontSize: '16px', fill: '#fff' });
        this.tweens.add({ targets: txt, y: player.y - 100, alpha: 0, duration: 1000, onComplete: () => txt.destroy() });
    }
}

function addSidekick() {
    // Sol ve sağa drone ekle
    let s1 = sidekicks.create(player.x - 30, player.y, 'sidekick');
    let s2 = sidekicks.create(player.x + 30, player.y, 'sidekick');
    
    // Oyuncuya sabitlemek için update içinde güncelleme yapıyoruz ama burada ömür biçelim
    this.time.delayedCall(10000, () => { // 10 saniye kalır
        if(s1.active) { s1.destroy(); }
        if(s2.active) { s2.destroy(); }
    });
}

function levelUp() {
    level++;
    score += 1000;
    levelText.setText('LEVEL: ' + level);
    levelText.setColor('#00ffff');
    
    // Bir sonraki boss için timer
    this.time.addEvent({ delay: 30000, callback: startBossFight, callbackScope: this });
}

function consumeFuel() {
    if (isGameOver) return;
    fuel -= 2;
    updateFuelBar();
    if (fuel <= 0) gameOver.call(this);
}

function updateFuelBar() {
    fuelBar.width = (fuel / 100) * 96;
    if (fuel < 20) fuelBar.setFillStyle(0xff0000);
    else fuelBar.setFillStyle(0x00ff00);
}

function createExplosion(scene, x, y, scale=1) {
    // Basit partikül patlaması
    let particles = scene.add.particles(0, 0, 'bullet', {
        x: x,
        y: y,
        speed: { min: 50, max: 200 },
        angle: { min: 0, max: 360 },
        scale: { start: 1 * scale, end: 0 },
        blendMode: 'ADD',
        lifespan: 500,
        tint: 0xffaa00,
        quantity: 10 * scale
    });
    scene.time.delayedCall(500, () => particles.destroy());
}

function gameOver() {
    isGameOver = true;
    this.physics.pause();
    player.setTint(0xff0000);
    
    let goText = this.add.text(CONFIG.width/2, CONFIG.height/2, 'GAME OVER', { fontSize: '64px', fill: '#f00', fontFamily: 'Courier' }).setOrigin(0.5);
    let restartBtn = this.add.text(CONFIG.width/2, CONFIG.height/2 + 80, 'YENİDEN BAŞLAT', { fontSize: '32px', fill: '#0f0', fontFamily: 'Courier' })
        .setOrigin(0.5)
        .setInteractive()
        .on('pointerdown', () => location.reload());
}

</script>
</body>
</html>
