<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>The Bartender | Convivium_</title>

  <style>
    /* =========================================================
       CRT ENGINE + JAPAN ALT THEMES
       ========================================================= */
    :root{
      --bg:#050505;
      --panel: rgba(0,0,0,0.82);
      --text:#e0e0e0;
      --muted:#999;
      --accent:#ff9900;
      --ok:#00ff66;
      --border:#444;

      /* CRT "beam" */
      --glow: 0 0 8px rgba(255,153,0,.55);
      --glowStrong: 0 0 16px rgba(255,153,0,.8);

      /* glitch intensity (0..1) */
      --glitch: 0;
      --scanOpacity: 1;
    }

    /* THEME: Showa Bar (Êò≠Âíå) ‚Äî amber terminal */
    [data-theme="showa"]{
      --accent:#ffb000;
      --ok:#7CFFB2;
      --glow: 0 0 9px rgba(255,176,0,.55);
      --glowStrong: 0 0 18px rgba(255,176,0,.8);
    }

    /* THEME: City Pop Neon */
    [data-theme="citypop"]{
      --accent:#ff4fd8;
      --ok:#4dffea;
      --glow: 0 0 10px rgba(255,79,216,.55);
      --glowStrong: 0 0 20px rgba(255,79,216,.8);
    }

    /* THEME: Ukiyo-e Ink (ink + paper) */
    [data-theme="ukiyoe"]{
      --bg:#070707;
      --panel: rgba(10,10,10,0.86);
      --accent:#d6c7a1;
      --ok:#b6ff7a;
      --text:#e8e2d4;
      --muted:#a9a39a;
      --glow: 0 0 6px rgba(214,199,161,.35);
      --glowStrong: 0 0 12px rgba(214,199,161,.55);
    }

    /* THEME: Shinjuku Cyber */
    [data-theme="shinjuku"]{
      --accent:#00d5ff;
      --ok:#ffd400;
      --glow: 0 0 10px rgba(0,213,255,.55);
      --glowStrong: 0 0 22px rgba(0,213,255,.8);
    }

    body{
      background: var(--bg);
      color: var(--text);
      font-family: "Courier New", Courier, monospace;
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow-x:hidden;
      animation: textShadow 1.6s infinite;
    }

    /* Scanline + RGB mask */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      z-index:2;
      pointer-events:none;
      opacity: var(--scanOpacity);
      background:
        linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.12) 50%),
        linear-gradient(90deg, rgba(255,0,0,0.06), rgba(0,255,0,0.02), rgba(0,0,255,0.06));
      background-size: 100% 2px, 3px 100%;
    }

    @media (prefers-reduced-motion: reduce){
      body{ animation:none; }
      body::before{ display:none; }
    }

    nav{ position:absolute; top:20px; left:20px; z-index:10; display:flex; gap:10px; flex-wrap:wrap; }
    nav a, nav button{
      color: var(--accent);
      text-decoration:none;
      font-weight:bold;
      border:1px solid var(--accent);
      padding:8px 12px;
      background: rgba(0,0,0,0.85);
      text-transform:uppercase;
      font-size:.78rem;
      letter-spacing:1px;
      cursor:pointer;
      font-family:inherit;
    }
    nav a:hover, nav button:hover{
      background: var(--accent);
      color:#000;
      box-shadow: 0 0 15px var(--accent);
    }

    .container{
      width:90%;
      max-width:620px;
      z-index:5;
      padding-bottom:50px;
    }

    .monitor-frame{
      border:2px solid #333;
      background:#080808;
      padding:15px;
      margin-bottom:18px;
      box-shadow: 0 0 24px rgba(255,153,0,0.08);
      position:relative;
      min-height:190px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }

    /* CRT warp + subtle vignette */
    .monitor-frame::after{
      content:"";
      position:absolute;
      inset:-40px;
      background:
        radial-gradient(ellipse at center, rgba(255,255,255,0.03) 0%, rgba(0,0,0,0.25) 55%, rgba(0,0,0,0.65) 100%);
      pointer-events:none;
      z-index:1;
      transform: scale(1.2);
      mix-blend-mode: overlay;
    }

    .status-badge{
      position:absolute;
      top:10px;
      right:10px;
      font-size:.72rem;
      color: var(--accent);
      border:1px solid var(--accent);
      padding:2px 6px;
      background:#000;
      opacity:.88;
      z-index:5;
    }

    .visual-wrap{
      position:relative;
      z-index:4;
      width:100%;
      display:flex;
      justify-content:center;
    }

    .visual-display{
      font-weight:bold;
      color: var(--accent);
      white-space: pre;
      font-size: 13px;
      line-height: 1.2;
      text-align:center;
      text-shadow: var(--glow);
      transition: transform .08s ease, opacity .12s ease, filter .12s ease;
      user-select:none;
      filter: saturate(1.05);
    }

    /* Controlled glitch: we shift + skew a bit using CSS variables */
    .visual-display.glitch{
      transform:
        translateX(calc(var(--glitch) * 10px))
        skewX(calc(var(--glitch) * -4deg));
      filter: contrast(calc(1 + var(--glitch)*.2)) saturate(calc(1.05 + var(--glitch)*.2));
      text-shadow: var(--glowStrong);
    }

    .dialogue-box{
      border:1px dashed #555;
      background: var(--panel);
      padding:20px 15px;
      min-height:62px;
      margin-bottom:18px;
      position:relative;
    }

    .dialogue-label{
      position:absolute;
      top:-10px;
      left:10px;
      background: var(--bg);
      color:#777;
      font-size:.7rem;
      padding:0 5px;
    }

    .typing-text{ font-size:1rem; line-height:1.45; color:#ddd; }

    .options-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      animation: fadeIn .5s ease;
    }

    .option-btn{
      background:transparent;
      border:1px solid var(--border);
      color: var(--muted);
      padding:15px 10px;
      cursor:pointer;
      font-family:inherit;
      font-size:.9rem;
      transition: all .2s;
      text-transform: uppercase;
    }
    .option-btn:hover{
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(255,153,0,0.05);
      box-shadow: 0 0 10px rgba(255,153,0,0.12);
    }
    .option-btn:disabled{ opacity:.5; cursor:not-allowed; }

    .result-card{
      display:none;
      text-align:left;
      border:1px solid var(--accent);
      background:#0a0a0a;
      animation: slideUp .6s ease;
      margin-top:18px;
    }

    .result-header{
      background: var(--accent);
      color:#000;
      padding:10px;
      font-weight:bold;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      font-size:1rem;
    }
    .result-body{ padding:20px; }
    .drink-desc{ margin-bottom:15px; color:#ccc; font-style: italic; font-size:.95rem; }

    .recipe-box{
      border-left:3px solid var(--accent);
      margin:15px 0;
      color:#aaa;
      font-size:.9rem;
      background: rgba(255,153,0,0.03);
      padding:10px 10px 10px 15px;
    }

    .price-btn{
      display:block; width:100%;
      text-align:center;
      background:#1a1a1a;
      color:#fff;
      padding:15px;
      text-decoration:none;
      border:1px dashed #666;
      margin-top:20px;
      transition: all .25s;
      font-size:.9rem;
      box-sizing:border-box;
      font-weight:bold;
    }
    .price-btn:hover{
      border-color: var(--ok);
      color: var(--ok);
      background:#001a00;
      box-shadow: 0 0 8px var(--ok);
    }

    .restart-btn{
      margin-top:15px;
      background:none;
      border:none;
      color:#555;
      cursor:pointer;
      width:100%;
      padding:10px;
      font-family:inherit;
    }
    .restart-btn:hover{ color:#777; }

    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
    @keyframes slideUp{ from{transform: translateY(20px); opacity:0} to{transform:translateY(0); opacity:1} }
    @keyframes textShadow{
      0% { text-shadow: 0.4px 0 1px rgba(0,30,255,0.5), -0.4px 0 1px rgba(255,0,80,0.3), 0 0 3px; }
      50% { text-shadow: 2.7px 0 1px rgba(0,30,255,0.5), -2.7px 0 1px rgba(255,0,80,0.3), 0 0 3px; }
      100% { text-shadow: 0.4px 0 1px rgba(0,30,255,0.5), -0.4px 0 1px rgba(255,0,80,0.3), 0 0 3px; }
    }

    @media (max-width: 600px){
      .options-grid{ grid-template-columns:1fr; }
      .container{ padding-top:60px; }
      .visual-display{ font-size: 11px; }
    }
  </style>
</head>

<body data-theme="showa">
  <nav>
    <a href="index.html">[ &lt; Geri ]</a>
    <button id="theme-btn" type="button">[ THEME: Êò≠Âíå ]</button>
    <button id="fx-btn" type="button">[ FX: ON ]</button>
  </nav>

  <div class="container">
    <div class="monitor-frame">
      <div id="status-badge" class="status-badge">[ ÂæÖÊ©ü / BEKLƒ∞YOR ]</div>

      <div class="visual-wrap">
        <div id="visual-content" class="visual-display" aria-hidden="true"></div>
      </div>
    </div>

    <div class="dialogue-box" aria-live="polite" aria-atomic="true">
      <span class="dialogue-label">SYSTEM / „Ç∑„Çπ„ÉÜ„É†</span>
      <div id="dialogue-text" class="typing-text"></div>
    </div>

    <div id="options-container" class="options-grid"></div>

    <div id="result-area" class="result-card">
      <div class="result-header">
        <span id="drink-name"></span>
        <span id="match-score">MATCH</span>
      </div>
      <div class="result-body">
        <div id="drink-description" class="drink-desc"></div>
        <div class="recipe-box">
          <strong style="color: var(--accent); display:block; margin-bottom:5px;">&gt; „É¨„Ç∑„Éî / RE√áETE:</strong>
          <div id="drink-recipe"></div>
        </div>

        <a id="price-link" href="#" target="_blank" rel="noopener noreferrer" class="price-btn">
          [ üåê ‰æ°Ê†º / G√úNCEL Fƒ∞YAT ARA≈ûTIRMASI ]
        </a>

        <button id="restart-btn" class="restart-btn" type="button">[ &lt; RESTART / ÂÜçËµ∑Âãï ]</button>
      </div>
    </div>
  </div>

  <script>
    /* =========================================================
       ADVANCED ANIMATION ENGINE
       - requestAnimationFrame timeline
       - state machine (IDLE/LISTEN/MIX/SCAN/SERVE)
       - controlled glitch + shake
       ========================================================= */

    const $ = (sel, root=document) => root.querySelector(sel);

    const visualEl   = $('#visual-content');
    const statusEl   = $('#status-badge');
    const dialogueEl = $('#dialogue-text');
    const optionsEl  = $('#options-container');
    const resultEl   = $('#result-area');

    const drinkNameEl   = $('#drink-name');
    const matchScoreEl  = $('#match-score');
    const drinkDescEl   = $('#drink-description');
    const drinkRecipeEl = $('#drink-recipe');
    const priceLinkEl   = $('#price-link');
    const restartBtn    = $('#restart-btn');

    const themeBtn = $('#theme-btn');
    const fxBtn    = $('#fx-btn');

    /* ---------- THEMES ---------- */
    const THEMES = [
      { key: 'showa',    label: 'Êò≠Âíå', hint: 'Showa Bar Terminal' },
      { key: 'citypop',  label: 'CITY', hint: 'City Pop Neon' },
      { key: 'ukiyoe',   label: 'ÊµÆ‰∏ñ', hint: 'Ukiyo-e Ink' },
      { key: 'shinjuku', label: 'Êñ∞ÂÆø', hint: 'Shinjuku Cyber' }
    ];
    let themeIndex = 0;

    function applyTheme(idx){
      themeIndex = (idx + THEMES.length) % THEMES.length;
      document.body.setAttribute('data-theme', THEMES[themeIndex].key);
      themeBtn.textContent = `[ THEME: ${THEMES[themeIndex].label} ]`;
    }

    /* ---------- FX Toggle ---------- */
    let fxEnabled = true;
    function setFx(on){
      fxEnabled = !!on;
      fxBtn.textContent = fxEnabled ? '[ FX: ON ]' : '[ FX: OFF ]';
      document.documentElement.style.setProperty('--scanOpacity', fxEnabled ? '1' : '0');
    }

    themeBtn.addEventListener('click', () => applyTheme(themeIndex + 1));
    fxBtn.addEventListener('click', () => setFx(!fxEnabled));

    /* ---------- ASCII ASSETS ---------- */
    const bartenderFrames = {
      idle: [
`   .---.
  /     \\
  | O O |
   \\ - /
  /  _  \\
 |  | |  |
 (  |_|  )`,

`   .---.
  /     \\
  | o o |
   \\ - /
  /  _  \\
 |  | |  |
 (  |_|  )`
      ],
      listen: [
`   .---.
  /     \\
  | > < |
   \\ o /
  / / \\ \\
 |  \\_/  |
 (  ...  )`,

`   .---.
  /     \\
  | 0 0 |
   \\ _ /
  / / \\ \\
 |  \\_/  |
 (  ...  )`
      ],
      mix: [
`   .---.
  /     \\
  | ^ ^ |
   \\ o /
  / / \\ \\
 |  SHA  |
 (  KE!  )`,

`   .---.
  /     \\
  | ^ ^ |
   \\ ~ /
  / / \\ \\
 |  SHA  |
 (  KE!  )`
      ],
      scan: [
`  [ SCAN ]
   .---.
  /     \\
  | - - |
   \\ _ /
  /  _  \\
 |  | |  |
 (  |_|  )`,

`  [ SCAN ]
   .---.
  /     \\
  | 0 - |
   \\ _ /
  /  _  \\
 |  | |  |
 (  |_|  )`
      ]
    };

    const glassArts = {
      rocks:
`   _________
  |         |
  |  ICE    |
  |   O     |
  |_________|
 [ ROCKS GL ]`,
      martini:
`   \\     /
    \\ o /
     \\ /
      |
      |
     _|_
 [ MARTINI ]`,
      highball:
`  |       |
  |   |   |
  |   |   |
  |   O   |
  |_______|
 [ HIGHBALL]`,
      shot:
`   _     _
   \\___/
   |   |
   |___|
  [ SHOT ]`,
      wine:
`    \\   /
     \\ /
      |
      |
     _|_
  [ WINE ]`,
      raki:
`   |     |
   |     |
   |_____|
   |     |
   |_____|
   [ RAKI ]`,
      mule:
`   |~~~~~|
  _|     |
 [_      |
   |_____|
  [ MUG  ]`,
      tiki:
`   /     \\
  |  O O  |
  |   ^   |
   \\  -  /
    -----
   [ TIKI ]`
    };

    /* ---------- ANIMATION ENGINE ---------- */
    const AnimState = {
      IDLE:   'IDLE',
      LISTEN: 'LISTEN',
      MIX:    'MIX',
      SCAN:   'SCAN',
      SERVE:  'SERVE'
    };

    const engine = {
      state: AnimState.IDLE,
      frame: 0,
      t: 0,
      last: performance.now(),
      fps: 6.5,               // ASCII frame rate target
      glitchChance: 0.10,      // base chance per second-ish
      shake: 0,                // 0..1
      glitch: 0,               // 0..1
      servingLock: false,
    };

    function setStatus(txt){
      statusEl.textContent = `[ ${txt} ]`;
    }

    function setCssGlitch(v){
      document.documentElement.style.setProperty('--glitch', String(v));
      if (v > 0.01) visualEl.classList.add('glitch');
      else visualEl.classList.remove('glitch');
    }

    function pickFrame(){
      const s = engine.state;
      if (s === AnimState.IDLE)   return bartenderFrames.idle;
      if (s === AnimState.LISTEN) return bartenderFrames.listen;
      if (s === AnimState.MIX)    return bartenderFrames.mix;
      if (s === AnimState.SCAN)   return bartenderFrames.scan;
      return bartenderFrames.idle;
    }

    function renderAscii(){
      if (engine.state === AnimState.SERVE) return; // SERVE modunda bardak ASCII sabit

      const frames = pickFrame();
      const idx = engine.frame % frames.length;
      visualEl.textContent = frames[idx];

      // shake -> k√º√ß√ºk translate
      if (fxEnabled && engine.shake > 0.01) {
        const amp = 2.0 * engine.shake;
        const x = (Math.random() * 2 - 1) * amp;
        const y = (Math.random() * 2 - 1) * (amp * 0.6);
        visualEl.style.transform = `translate(${x}px, ${y}px)`;
      } else {
        visualEl.style.transform = '';
      }
    }

    function maybeGlitch(dt){
      if (!fxEnabled) { engine.glitch = 0; setCssGlitch(0); return; }

      // ‚ÄúKontroll√º‚Äù glitch: kƒ±sa, arada sƒ±rada
      const chance = engine.glitchChance * dt;
      if (Math.random() < chance) {
        engine.glitch = 1;
      }

      // decay
      engine.glitch *= Math.pow(0.02, dt); // hƒ±zlƒ± s√∂n
      setCssGlitch(engine.glitch);
    }

    function update(dt){
      engine.t += dt;

      // state-based shake
      const targetShake =
        engine.state === AnimState.MIX  ? 1.0 :
        engine.state === AnimState.SCAN ? 0.25 :
        0.08;

      engine.shake += (targetShake - engine.shake) * Math.min(1, dt * 6);

      // frame stepping (fps)
      const step = 1 / engine.fps;
      while (engine.t >= step) {
        engine.t -= step;
        engine.frame++;
        renderAscii();
      }

      maybeGlitch(dt);
    }

    function loop(now){
      const dt = Math.min(0.05, (now - engine.last) / 1000);
      engine.last = now;
      update(dt);
      requestAnimationFrame(loop);
    }

    requestAnimationFrame(loop);

    /* ---------- TYPEWRITER (same idea, stable) ---------- */
    let typingTimer = null;
    let isTyping = false;

    function setOptionsEnabled(enabled){
      [...optionsEl.querySelectorAll('button.option-btn')].forEach(b => b.disabled = !enabled);
    }

    function typeWriter(text, speed=18){
      if (typingTimer) clearTimeout(typingTimer);
      typingTimer = null;

      isTyping = true;
      setOptionsEnabled(false);

      return new Promise((resolve) => {
        let i = 0;
        const tick = () => {
          dialogueEl.innerHTML = text.substring(0, i+1) + `<span style="color:var(--accent)">_</span>`;
          i++;
          if (i < text.length) typingTimer = setTimeout(tick, speed);
          else {
            dialogueEl.innerHTML = text;
            isTyping = false;
            setOptionsEnabled(true);
            resolve();
          }
        };
        tick();
      });
    }

    /* =========================================================
       CONTENT LOGIC (Your original flow)
       ========================================================= */

    const drinksDB = [
      { name: "OLD FASHIONED", glass: "rocks", tags: { mood: "deep", taste: "bitter", intensity: "high" }, desc: "Viskinin en saf hali. D√º≈ü√ºnmek ve yava≈ü yudumlamak i√ßin.", recipe: "‚Ä¢ 6cl Burbon<br>‚Ä¢ 1 K√ºp ≈ûeker<br>‚Ä¢ Angostura Bitters", query: "viski fiyatlarƒ±" },
      { name: "WHISKEY SOUR", glass: "rocks", tags: { mood: "relax", taste: "sour", intensity: "medium" }, desc: "Ek≈üi, tatlƒ± ve sert. ƒ∞peksi bir doku.", recipe: "‚Ä¢ 6cl Viski<br>‚Ä¢ 3cl Limon Suyu<br>‚Ä¢ ≈ûeker ≈ûurubu", query: "viski fiyatlarƒ±" },
      { name: "NEGRONI", glass: "rocks", tags: { mood: "classy", taste: "bitter", intensity: "high" }, desc: "ƒ∞talyan asaleti.", recipe: "‚Ä¢ 3cl Cin<br>‚Ä¢ 3cl Campari<br>‚Ä¢ 3cl Kƒ±rmƒ±zƒ± Vermut", query: "cin campari vermut" },
      { name: "GIN TONIC", glass: "highball", tags: { mood: "relax", taste: "sour", intensity: "medium" }, desc: "Basit ve m√ºkemmel.", recipe: "‚Ä¢ 5cl Cin<br>‚Ä¢ 15cl Tonik<br>‚Ä¢ Limon", query: "cin fiyatlarƒ±" },
      { name: "ESPRESSO MARTINI", glass: "martini", tags: { mood: "energy", taste: "sweet", intensity: "high" }, desc: "Uyandƒ±rƒ±r ve √ßarpar.", recipe: "‚Ä¢ 5cl Votka<br>‚Ä¢ 3cl Kahve Lik√∂r√º<br>‚Ä¢ 1 shot Espresso", query: "votka kahlua fiyat" },
      { name: "MOSCOW MULE", glass: "mule", tags: { mood: "relax", taste: "spicy", intensity: "medium" }, desc: "Zencefil ferahlƒ±ƒüƒ±.", recipe: "‚Ä¢ 5cl Votka<br>‚Ä¢ Zencefil Gazozu<br>‚Ä¢ Limon", query: "votka ginger beer" },
      { name: "MOJITO", glass: "highball", tags: { mood: "energy", taste: "sour", intensity: "medium" }, desc: "Nane ferahlƒ±ƒüƒ±.", recipe: "‚Ä¢ 5cl Rom<br>‚Ä¢ Nane<br>‚Ä¢ ≈ûeker & Soda", query: "beyaz rom fiyat" },
      { name: "MARGARITA", glass: "martini", tags: { mood: "energy", taste: "sour", intensity: "high" }, desc: "Meksika ate≈üi.", recipe: "‚Ä¢ 5cl Tekila<br>‚Ä¢ Portakal Lik√∂r√º<br>‚Ä¢ Limon & Tuz", query: "tekila fiyatlarƒ±" },
      { name: "RAKI (DUBLE)", glass: "raki", tags: { mood: "deep", taste: "herbal", intensity: "high" }, desc: "Aslan s√ºt√º.", recipe: "‚Ä¢ Duble Rakƒ±<br>‚Ä¢ Soƒüuk Su<br>‚Ä¢ Peynir & Kavun", query: "rakƒ± fiyatlarƒ±" },
      { name: "APEROL SPRITZ", glass: "wine", tags: { mood: "relax", taste: "fruity", intensity: "low" }, desc: "ƒ∞talyan aperitifi.", recipe: "‚Ä¢ Prosecco<br>‚Ä¢ Aperol<br>‚Ä¢ Soda", query: "aperol fiyatlarƒ±" },
      { name: "LONG ISLAND", glass: "highball", tags: { mood: "rebel", taste: "sour", intensity: "high" }, desc: "5 √ße≈üit alkol.", recipe: "‚Ä¢ Votka, Cin, Rom, Tekila, Lik√∂r<br>‚Ä¢ Kola", query: "votka cin rom fiyat" },
    ];

    const questions = [
      {
        text: "Ho≈ü geldin. Ruh halin nasƒ±l?",
        options: [
          { label: "Sakinlik / Reset", value: "relax" },
          { label: "Enerjik / Parti", value: "energy" },
          { label: "Dertli / Derin", value: "deep" },
          { label: "Sofistike / ≈ûƒ±k", value: "classy" },
          { label: "Maceracƒ± / Egzotik", value: "adventure" },
          { label: "Asi / Kural Tanƒ±maz", value: "rebel" }
        ],
        key: "mood"
      },
      {
        text: "Damaƒüƒ±nda ne arƒ±yorsun?",
        options: [
          { label: "Ek≈üi ve Ferah", value: "sour" },
          { label: "Acƒ± / Karakterli", value: "bitter" },
          { label: "Tatlƒ± / Yumu≈üak", value: "sweet" },
          { label: "Meyvemsi", value: "fruity" },
          { label: "Kremamsƒ± / Tatlƒ±", value: "creamy" },
          { label: "Baharatlƒ± / Otlu", value: "herbal" },
          { label: "Yakƒ±cƒ± / Zencefil", value: "spicy" }
        ],
        key: "taste"
      },
      {
        text: "Son olarak, sertlik derecesi?",
        options: [
          { label: "Hafif (Keyiflik)", value: "low" },
          { label: "Orta (Standart)", value: "medium" },
          { label: "Sert (√áarpsƒ±n)", value: "high" }
        ],
        key: "intensity"
      }
    ];

    const state = { step: 0, prefs: {} };

    function scoreDrink(drink){
      let s = 0;
      if (drink.tags.mood === state.prefs.mood) s += 5;
      if (drink.tags.taste === state.prefs.taste) s += 4;
      if (drink.tags.intensity === state.prefs.intensity) s += 3;
      s += Math.random() * 2;
      return s;
    }

    async function renderStep(){
      optionsEl.innerHTML = "";
      optionsEl.style.display = "grid";
      resultEl.style.display = "none";

      if (state.step < questions.length) {
        engine.state = AnimState.LISTEN;
        setStatus("ËÅû„ÅÑ„Å¶„ÅÑ„Çã / Dƒ∞NLƒ∞YOR...");
        await typeWriter(questions[state.step].text, 18);

        for (const opt of questions[state.step].options){
          const btn = document.createElement('button');
          btn.type = "button";
          btn.className = "option-btn";
          btn.textContent = `> ${opt.label}`;
          btn.addEventListener('click', () => {
            if (isTyping) return;
            state.prefs[questions[state.step].key] = opt.value;
            state.step++;
            renderStep();
          });
          optionsEl.appendChild(btn);
        }
        return;
      }

      await calculateAndShowResult();
    }

    async function calculateAndShowResult(){
      engine.state = AnimState.SCAN;
      setStatus("Ëß£Êûê‰∏≠ / HAZIRLIYOR...");
      await typeWriter("Veriler i≈üleniyor... (Ëß£Êûê‰∏≠) En uygun karƒ±≈üƒ±m taranƒ±yor...", 16);

      engine.state = AnimState.MIX;
      setStatus("SHAKE / „Ç∑„Çß„Ç§„ÇØ...");
      await new Promise(r => setTimeout(r, 900));

      // pick best
      let best = drinksDB[0];
      let bestScore = -Infinity;
      for (const d of drinksDB){
        const s = scoreDrink(d);
        if (s > bestScore){ bestScore = s; best = d; }
      }

      showResult(best, bestScore);
    }

    function showResult(drink, score){
      // SERVE: freeze bartender, show glass art
      engine.state = AnimState.SERVE;
      setStatus("Êèê‰æõ / SERVE");

      visualEl.classList.add('glitch');
      document.documentElement.style.setProperty('--glitch', '0.15');

      setTimeout(() => {
        visualEl.textContent = (glassArts[drink.glass] || glassArts.rocks);
        visualEl.style.color = "var(--ok)";
        visualEl.style.textShadow = "0 0 12px var(--ok)";
        document.documentElement.style.setProperty('--glitch', '0');

        // UI
        optionsEl.style.display = "none";
        resultEl.style.display = "block";
        drinkNameEl.textContent = drink.name;
        drinkDescEl.textContent = drink.desc;
        drinkRecipeEl.innerHTML = drink.recipe;

        const normalized = Math.max(0, Math.min(1, score / 14));
        matchScoreEl.textContent = `%${Math.round(82 + normalized * 17)} MATCH`;

        priceLinkEl.href = `https://www.google.com/search?q=${encodeURIComponent(drink.query + " 2026")}`;

        dialogueEl.innerHTML =
          `<span style="color:var(--accent)">Êèê‰æõÂÆå‰∫Ü / SERVƒ∞S EDƒ∞LDƒ∞:</span><br>` +
          `Senin i√ßin se√ßim: <span style="color:var(--ok)">${drink.name}</span>`;

      }, 450);
    }

    restartBtn.addEventListener('click', () => location.reload());

    /* ---------- Boot ---------- */
    applyTheme(0);
    setFx(true);
    engine.state = AnimState.IDLE;
    setStatus("ÂæÖÊ©ü / BEKLƒ∞YOR");
    typeWriter("„ÅÑ„Çâ„Å£„Åó„ÇÉ„ÅÑ„Åæ„Åõ‚Ä¶ Ho≈ü geldin. (Sistem hazƒ±r.)", 16).then(renderStep);
  </script>
</body>
</html>
