<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>The Bartender â€“ Reforged</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html,body {
    margin:0; padding:0;
    background:#050507;
    color:#fff;
    font-family: system-ui, monospace;
    overflow:hidden;
}
#ui {
    position:absolute;
    top:12px; left:12px;
    z-index:10;
    font-size:14px;
    opacity:0.9;
}
</style>
</head>
<body>

<div id="ui">
    <div id="hp">HP: 100</div>
    <div id="xp">XP: 0</div>
    <div id="lvl">LVL: 1</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>
<script>
/* ==========================
   GLOBAL CONFIG
========================== */
const WIDTH = window.innerWidth;
const HEIGHT = window.innerHeight;

/* ==========================
   UTILS
========================== */
function hitStop(scene, time=60) {
    scene.time.timeScale = 0.05;
    scene.time.delayedCall(time, ()=>scene.time.timeScale = 1);
}

/* ==========================
   MAIN SCENE
========================== */
class GameScene extends Phaser.Scene {
    constructor() {
        super('Game');
    }

    preload(){}

    create() {
        /* CAMERA */
        this.cameras.main.setBackgroundColor('#050507');
        this.cameras.main.fadeIn(800,0,0,0);

        /* PLAYER */
        this.player = this.add.circle(WIDTH/2, HEIGHT*0.75, 10, 0x00ffee);
        this.physics.add.existing(this.player);
        this.player.body.setDamping(true);
        this.player.body.setDrag(0.92);
        this.player.body.setMaxVelocity(420);

        this.player.hp = 100;
        this.player.xp = 0;
        this.player.lvl = 1;

        /* GLOW FX (fake bloom) */
        this.playerGlow = this.add.circle(this.player.x, this.player.y, 18, 0x00ffee, 0.25);

        /* CONTROLS */
        this.cursors = this.input.keyboard.createCursorKeys();
        this.input.on('pointermove', p=>{
            this.pointer = p;
        });

        /* BULLETS */
        this.bullets = this.physics.add.group();

        this.input.on('pointerdown', ()=>this.shoot());

        /* ENEMIES */
        this.enemies = this.physics.add.group();
        this.time.addEvent({
            delay: 800,
            loop: true,
            callback: ()=>this.spawnEnemy()
        });

        /* COLLISIONS */
        this.physics.add.overlap(this.bullets, this.enemies, (b,e)=>{
            b.destroy();
            e.hp -= 1;
            hitStop(this,40);
            if(e.hp<=0){
                this.killEnemy(e);
            }
        });

        this.physics.add.overlap(this.player, this.enemies, (p,e)=>{
            e.destroy();
            this.player.hp -= 10;
            this.cameras.main.shake(120,0.01);
            document.getElementById('hp').innerText = "HP: "+this.player.hp;
        });
    }

    shoot() {
        const b = this.add.circle(this.player.x, this.player.y-10, 3, 0xffffff);
        this.physics.add.existing(b);
        this.bullets.add(b);
        b.body.setVelocityY(-600);
    }

    spawnEnemy() {
        const x = Phaser.Math.Between(40, WIDTH-40);
        const e = this.add.rectangle(x, -20, 18, 18, 0xff3366);
        this.physics.add.existing(e);
        e.body.setVelocityY(Phaser.Math.Between(80,140));
        e.hp = 3;
        this.enemies.add(e);

        // glow
        e.glow = this.add.rectangle(e.x, e.y, 30, 30, 0xff3366, 0.2);
    }

    killEnemy(e){
        e.glow.destroy();
        e.destroy();
        this.player.xp += 10;
        if(this.player.xp >= this.player.lvl*50){
            this.player.lvl++;
            this.player.xp = 0;
            document.getElementById('lvl').innerText = "LVL: "+this.player.lvl;
            this.cameras.main.flash(200,0,255,200);
        }
        document.getElementById('xp').innerText = "XP: "+this.player.xp;
    }

    update() {
        /* MOVEMENT */
        if(this.cursors.left.isDown) this.player.body.velocity.x -= 24;
        if(this.cursors.right.isDown) this.player.body.velocity.x += 24;
        if(this.cursors.up.isDown) this.player.body.velocity.y -= 24;
        if(this.cursors.down.isDown) this.player.body.velocity.y += 24;

        /* GLOW FOLLOW */
        this.playerGlow.x = this.player.x;
        this.playerGlow.y = this.player.y;

        this.enemies.getChildren().forEach(e=>{
            e.glow.x = e.x;
            e.glow.y = e.y;
        });
    }
}

/* ==========================
   GAME INIT
========================== */
const game = new Phaser.Game({
    type: Phaser.WEBGL,
    width: WIDTH,
    height: HEIGHT,
    physics: {
        default: 'arcade',
        arcade: { debug:false }
    },
    scene: [GameScene]
});
</script>
</body>
</html>
